+++
title = 'JWT的原理和思考'
date = 2024-08-30
+++

### JWT 是啥？

JWT（JSON Web Token）是一种用于在各方之间作为 JSON 对象安全传输信息的开放标准（RFC 7519）。该信息可以被验证和信任，因为它是经过数字签名的。JWT 通常用于身份验证和信息交换。

JWT 由三部分组成，通常以点 (.) 分隔：

1. **Header**（头部）：描述签名的算法和类型，通常使用的是 HMAC SHA256。
2. **Payload**（负载）：包含声明（claims），这部分是实际的传输数据，可以包括用户身份信息、权限、过期时间等。
3. **Signature**（签名）：用于验证消息是否未被篡改。它是通过将头部和负载组合在一起，使用指定的签名算法（如 HMAC SHA256）以及一个密钥生成的。

JWT 的基本格式如下：

```
xxxxx.yyyyy.zzzzz
```

### JWT 的加密流程

JWT 的一个显著特点是“自包含”，也就是说 JWT 本身包含了所有的信息，无需服务器存储状态，服务器只负责每一次的验证。这样服务器就无需存储客户端状态（如登录状态、过期时间等）。

登录时，服务端会根据用户登录信息和时间戳，返回给客户端一个 JWT token。

![JWT 的原理和思考](https://blog-1307107697.cos.ap-shanghai.myqcloud.com/JWT%20的原理和思考.png)

![JWT 的原理和思考-1](https://blog-1307107697.cos.ap-shanghai.myqcloud.com/JWT%20的原理和思考-1.png)

前端登录成功后，会将 token 存储在 localStorage 中。

![JWT 的原理和思考-2](https://blog-1307107697.cos.ap-shanghai.myqcloud.com/JWT%20的原理和思考-2.png)

![JWT 的原理和思考-3](https://blog-1307107697.cos.ap-shanghai.myqcloud.com/JWT%20的原理和思考-3.png)

### 有什么优点？

之后的 API 调用中，可以不再传递用户信息。通过前端 Hook 和后端 Hook，自动实施鉴权和重定向。

前端可以设置全局请求拦截器，将 JWT token 添加到请求头中。

![JWT 的原理和思考-4](https://blog-1307107697.cos.ap-shanghai.myqcloud.com/JWT%20的原理和思考-4.png)

![JWT 的原理和思考-5](https://blog-1307107697.cos.ap-shanghai.myqcloud.com/JWT%20的原理和思考-5.png)

这样一来，登录模块的权限检查可以独立于具体业务进行鉴权；前端也不再需要在业务代码中传递用户信息，从而提高了代码的可维护性。

### 其他的做法：Session + Cookie

在这种方式中，状态存储在服务端。服务器在用户登录时创建一个会话（Session），并将会话 ID 存储在服务器端（通常在内存或数据库中）。服务器会将会话 ID 通过 cookie 发送到客户端，客户端每次请求时会自动携带这个 cookie。服务器通过会话 ID 查找和验证会话数据，以确定用户身份。与 JWT 不同的是，部分信息存在服务端，没有“自包含”的特点。

### 其他的做法：OAuth 2.0

Google 登录是 OAuth 2.0 的具体实现，通过 OAuth 2.0 协议来处理用户身份验证和授权。当用户点击应用中的“使用 Google 登录”按钮时，应用会将用户重定向到 Google 的授权服务器，请求访问用户的 Google 账号信息。用户在 Google 授权页面登录并决定是否授权应用访问其信息。若同意授权，Google 授权服务器会生成一个授权码，并将用户重定向回应用的回调地址，携带授权码作为参数。应用随后使用授权码向 Google 授权服务器请求访问令牌，包含应用 ID、应用密钥、授权码和回调地址等信息。若授权码有效，Google 授权服务器会返回一个访问令牌，并可选地提供一个刷新令牌。应用随后使用访问令牌请求 Google 资源服务器，获取用户的 Google 账号信息，如电子邮件和用户名，以便在应用中创建或登录用户账户。

在 OAuth 2.0 中，Google 提供的访问令牌（Access Token）是有有效期的。一旦令牌过期，服务器端需要判断并处理。Spring Security 会自动处理令牌的过期。若访问令牌过期，Spring Security 会自动尝试使用刷新令牌（Refresh Token）获取新的访问令牌。如果刷新令牌也过期，用户将被重定向到登录页面，要求重新进行认证。如果需要自定义过期处理逻辑，可以实现 `OAuth2AuthorizedClientService` 接口，并重写其中的方法来管理和判断令牌的过期状态。

因此看来，OAuth 2.0 是一种协议，由各大品牌厂商分别实现自己的登录模块，并提供 Token 给应用程序，实现了登录和主应用的解耦。
